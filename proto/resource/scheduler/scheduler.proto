syntax = "proto3";
package resource.scheduler;
option go_package = "github.com/9triver/iarnet/internal/proto/resource/scheduler";

import "resource/resource.proto";

// SchedulerService 提供远程调度服务，支持跨节点部署 component
service SchedulerService {
  // DeployComponent 在指定节点上部署 component
  // 如果 target_node_id 为空，则在本地节点部署
  rpc DeployComponent(DeployComponentRequest) returns (DeployComponentResponse);

  // GetDeploymentStatus 获取部署状态
  rpc GetDeploymentStatus(GetDeploymentStatusRequest) returns (GetDeploymentStatusResponse);

  // ProposeLocalSchedule 在当前节点上执行一次“只调度不部署”的本地调度
  // 调用方传入资源需求，当前节点返回其选中的本地 provider 及其可用资源信息
  rpc ProposeLocalSchedule(ProposeLocalScheduleRequest) returns (ProposeLocalScheduleResponse);

  // CommitLocalSchedule 根据之前 ProposeLocalSchedule 返回的调度结果，在当前节点上确认部署
  // 这是一个两阶段提交的第二阶段：第一阶段只做调度，第二阶段真正执行部署
  rpc CommitLocalSchedule(CommitLocalScheduleRequest) returns (DeployComponentResponse);

  // ListProviders 获取当前节点的所有 Provider 列表及其资源信息
  // 用于无自主调度能力的场景：调用方可以根据 Provider 列表在本地进行调度决策
  rpc ListProviders(ListProvidersRequest) returns (ListProvidersResponse);

  // UndeployComponent 移除 component
  // 用于跨节点场景：由远程 iarnet 节点调用，移除其管理的 component
  rpc UndeployComponent(UndeployComponentRequest) returns (UndeployComponentResponse);
}

// DeployComponentRequest 部署 component 请求
message DeployComponentRequest {
  // 运行时环境（如 "python"）
  string runtime_env = 1;
  
  // 资源请求
  resource.Info resource_request = 2;
  
  // 目标节点 ID（可选，为空则在本地节点部署）
  // 如果指定，将在该节点上部署 component
  string target_node_id = 3;
  
  // 目标节点地址（可选，如果指定了 target_node_id 但需要直接连接）
  string target_node_address = 4;

  // 由外部节点委托时需要回连的上游地址
  string upstream_zmq_address = 5;
  string upstream_store_address = 6;
  string upstream_logger_address = 7;
}

// DeployComponentResponse 部署 component 响应
message DeployComponentResponse {
  // 是否成功
  bool success = 1;
  
  // 错误信息（如果失败）
  string error = 2;
  
  // Component 信息
  ComponentInfo component = 3;
  
  // 部署的节点 ID
  string node_id = 4;
  
  // 部署的节点名称
  string node_name = 5;
  
  // Provider ID（实际部署的 provider）
  string provider_id = 6;
}

// ComponentInfo Component 信息
message ComponentInfo {
  // Component ID
  string component_id = 1;
  
  // 镜像名称
  string image = 2;
  
  // 资源使用情况
  resource.Info resource_usage = 3;
  
  // Provider ID
  string provider_id = 4;
}

// GetDeploymentStatusRequest 获取部署状态请求
message GetDeploymentStatusRequest {
  // Component ID
  string component_id = 1;
  
  // 节点 ID（可选，如果指定则从该节点查询）
  string node_id = 2;
}

// GetDeploymentStatusResponse 获取部署状态响应
message GetDeploymentStatusResponse {
  // 是否成功
  bool success = 1;
  
  // 错误信息（如果失败）
  string error = 2;
  
  // Component 状态
  ComponentStatus status = 3;
  
  // Component 信息
  ComponentInfo component = 4;
}

// ProposeLocalScheduleRequest 本地调度请求（只调度，不部署）
message ProposeLocalScheduleRequest {
  // 资源请求
  resource.Info resource_request = 1;
}

// ProposeLocalScheduleResponse 本地调度响应（返回选中的 Provider 及其可用资源）
message ProposeLocalScheduleResponse {
  // 是否成功
  bool success = 1;

  // 错误信息（如果失败）
  string error = 2;

  // 当前节点信息
  string node_id = 3;
  string node_name = 4;

  // 被选中的本地 Provider ID
  string provider_id = 5;

  // 该 Provider 当前可用资源视图
  resource.Info available = 6;
}

// CommitLocalScheduleRequest 确认部署请求（两阶段提交的第二阶段）
message CommitLocalScheduleRequest {
  // 运行时环境（如 "python"）
  string runtime_env = 1;

  // 资源请求（应与 ProposeLocalSchedule 时一致）
  resource.Info resource_request = 2;

  // Provider ID（从 ProposeLocalSchedule 返回的调度结果中获取）
  string provider_id = 3;

  // 由外部节点委托时需要回连的上游地址
  string upstream_zmq_address = 4;
  string upstream_store_address = 5;
  string upstream_logger_address = 6;
}

// ListProvidersRequest 获取 Provider 列表请求
message ListProvidersRequest {
  // 是否包含资源信息（可用资源、容量等），默认 true
  bool include_resources = 1;
}

// ListProvidersResponse 获取 Provider 列表响应
message ListProvidersResponse {
  // 是否成功
  bool success = 1;

  // 错误信息（如果失败）
  string error = 2;

  // 当前节点信息
  string node_id = 3;
  string node_name = 4;

  // Provider 列表
  repeated ProviderInfo providers = 5;
}

// ProviderInfo Provider 信息
message ProviderInfo {
  // Provider ID
  string provider_id = 1;

  // Provider 名称
  string provider_name = 2;

  // Provider 类型（如 "docker", "k8s"）
  string provider_type = 3;

  // Provider 状态（connected, disconnected）
  string status = 4;

  // 可用资源（如果 include_resources=true）
  resource.Info available = 5;

  // 总容量（如果 include_resources=true）
  resource.Info total_capacity = 6;

  // 已使用资源（如果 include_resources=true）
  resource.Info used = 7;

  // 资源标签（支持的计算资源类型）
  ResourceTags resource_tags = 8;
}

// ResourceTags 资源标签
message ResourceTags {
  bool cpu = 1;
  bool gpu = 2;
  bool memory = 3;
  bool camera = 4;
}

// UndeployComponentRequest 移除 component 请求
message UndeployComponentRequest {
  // Component ID
  string component_id = 1;
  
  // Provider ID（可选，如果提供则直接使用，否则从 component 信息中查找）
  string provider_id = 2;
}

// UndeployComponentResponse 移除 component 响应
message UndeployComponentResponse {
  // 是否成功
  bool success = 1;
  
  // 错误信息（如果失败）
  string error = 2;
}

// ComponentStatus Component 状态
enum ComponentStatus {
  COMPONENT_STATUS_UNKNOWN = 0;
  COMPONENT_STATUS_DEPLOYING = 1;
  COMPONENT_STATUS_RUNNING = 2;
  COMPONENT_STATUS_STOPPED = 3;
  COMPONENT_STATUS_ERROR = 4;
}

