syntax = "proto3";

package discovery;

option go_package = "github.com/9triver/iarnet/internal/proto/resource/discovery";

// ==================== 资源信息类型 ====================

// ResourceInfo 资源信息
message ResourceInfo {
    int64 cpu = 1;      // CPU millicores (毫核)
    int64 memory = 2;   // Memory bytes (字节)
    int64 gpu = 3;      // GPU count (数量)
}

// ResourceCapacity 资源容量
message ResourceCapacity {
    ResourceInfo total = 1;      // 总资源
    ResourceInfo used = 2;        // 已使用资源
    ResourceInfo available = 3;  // 可用资源
}

// ResourceTags 资源标签
message ResourceTags {
    bool cpu = 1;
    bool gpu = 2;
    bool memory = 3;
    bool camera = 4;
}

// NodeStatus 节点状态枚举
enum NodeStatus {
    NODE_STATUS_UNKNOWN = 0;
    NODE_STATUS_ONLINE = 1;
    NODE_STATUS_OFFLINE = 2;
    NODE_STATUS_ERROR = 3;
}

// ==================== 节点信息 ====================

// PeerNodeInfo 节点信息（用于 gossip 交换）
message PeerNodeInfo {
    string node_id = 1;
    string node_name = 2;
    string address = 3;           // discovery RPC host:port
    string domain_id = 4;
    string scheduler_address = 12; // Scheduler RPC host:port
    
    ResourceCapacity resource_capacity = 5;
    ResourceTags resource_tags = 6;
    
    NodeStatus status = 7;
    int64 last_seen = 8;          // Unix nanoseconds
    int64 last_updated = 9;        // Unix nanoseconds
    
    // Gossip 元数据
    uint64 version = 10;          // 版本号（用于冲突解决）
    int32 gossip_count = 11;      // 传播次数（用于 TTL）
}

// ==================== Gossip 消息 ====================

// NodeInfoGossipMessage 节点信息 gossip 消息
message NodeInfoGossipMessage {
    // 发送方信息
    string sender_node_id = 1;
    string sender_address = 2;
    string sender_domain_id = 3;
    
    // 节点信息列表（可以包含多个节点，包括发送方自己和其他已知节点）
    repeated PeerNodeInfo nodes = 4;
    
    // 消息元数据
    string message_id = 5;        // 消息唯一标识（用于去重）
    int64 timestamp = 6;          // 消息时间戳（Unix nanoseconds）
    int32 ttl = 7;                // 生存时间（跳数，防止无限传播）
    int32 max_hops = 8;           // 最大跳数
}

// NodeInfoGossipResponse 节点信息 gossip 响应
message NodeInfoGossipResponse {
    // 接收方返回的节点信息（可能包含接收方自己的信息和其他已知节点）
    repeated PeerNodeInfo nodes = 1;
    
    // 响应元数据
    string message_id = 2;        // 对应的请求消息 ID
    int64 timestamp = 3;          // 响应时间戳
}

// ==================== 资源查询 ====================

// ResourceRequest 资源请求
message ResourceRequest {
    int64 cpu = 1;                 // millicores
    int64 memory = 2;               // bytes
    int64 gpu = 3;                  // count
}

// ResourceQueryRequest 资源查询请求
message ResourceQueryRequest {
    string query_id = 1;          // 查询唯一标识
    string requester_node_id = 2;
    string requester_address = 3;
    string requester_domain_id = 4;
    
    // 查询条件
    ResourceRequest resource_request = 5;  // 资源需求
    ResourceTags required_tags = 6;       // 需要的资源标签（可选）
    
    // 查询元数据
    int64 timestamp = 7;          // 查询时间戳
    int32 max_hops = 8;            // 最大跳数（限制查询范围）
    int32 ttl = 9;                 // 生存时间
    int32 current_hops = 10;       // 当前跳数
}

// ResourceQueryResponse 资源查询响应
message ResourceQueryResponse {
    string query_id = 1;           // 对应的查询 ID
    string responder_node_id = 2;
    string responder_address = 3;
    
    // 可用节点列表（满足条件的节点）
    repeated PeerNodeInfo available_nodes = 4;
    
    // 响应元数据
    int64 timestamp = 5;            // 响应时间戳
    bool is_final = 6;              // 是否为最终响应（不再转发）
}

// ==================== Peer 列表交换 ====================

// PeerListExchangeRequest Peer 列表交换请求
message PeerListExchangeRequest {
    string requester_node_id = 1;
    string requester_address = 2;
    string requester_domain_id = 3;
    
    // 已知的 peer 地址列表
    repeated string known_peers = 4;  // 格式：host:port
    
    int64 timestamp = 5;
}

// PeerListExchangeResponse Peer 列表交换响应
message PeerListExchangeResponse {
    // 返回的 peer 地址列表（可能包含新的 peer）
    repeated string known_peers = 1;  // 格式：host:port
    
    int64 timestamp = 2;
}

// ==================== 获取本地节点信息 ====================

// GetLocalNodeInfoRequest 获取本地节点信息请求
message GetLocalNodeInfoRequest {
    // 可以为空，表示请求本地节点信息
}

// GetLocalNodeInfoResponse 获取本地节点信息响应
message GetLocalNodeInfoResponse {
    PeerNodeInfo node_info = 1;
}

// ==================== 服务定义 ====================

service DiscoveryService {
    // GossipNodeInfo 交换节点信息（gossip 协议）
    rpc GossipNodeInfo(NodeInfoGossipMessage) returns (NodeInfoGossipResponse);
    
    // QueryResources 查询资源（主动查询）
    rpc QueryResources(ResourceQueryRequest) returns (ResourceQueryResponse);
    
    // ExchangePeerList 交换 peer 列表（用于节点发现）
    rpc ExchangePeerList(PeerListExchangeRequest) returns (PeerListExchangeResponse);
    
    // GetLocalNodeInfo 获取本地节点信息（用于其他节点查询）
    rpc GetLocalNodeInfo(GetLocalNodeInfoRequest) returns (GetLocalNodeInfoResponse);
}

