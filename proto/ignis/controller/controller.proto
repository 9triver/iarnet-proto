syntax = "proto3";
package ignis.controller;
option go_package = "github.com/9triver/iarnet/internal/proto/ignis/controller";

import "common/types.proto";
import "common/messages.proto";

enum CommandType {
  UNSPECIFIED = 0; // unknown command type
  ACK = 1; // acknowledged
  FR_READY = 2;
  FR_APPEND_DATA = 3; // frontend: append data node
  FR_APPEND_ACTOR = 4; // front: append actor (for debugging purpose)
  FR_APPEND_PY_FUNC = 5; // frontend: append python function (control node definition)
  FR_APPEND_PY_CLASS = 6; // frontend: append python class (control node definition)
  FR_APPEND_ARG = 7; // frontend: append function arg to specified actor
  FR_APPEND_CLASS_METHOD_ARG = 8; // frontend: append class method arg to specified actor
  FR_INVOKE = 9;
  BK_RETURN_RESULT = 10; // backend: send back execution result
  FR_REQUEST_OBJECT=11; // frontend: request object from object store
  BK_RESPONSE_OBJECT=12; // backend: response object to request object
  FR_APPEND_DAG_NODE = 13; // frontend: append DAG node
}

// Ack and Ready are now in common/messages.proto

message Data {
  enum ObjectType {
    OBJ_UNSPECIFIED = 0;
    OBJ_REF = 1;
    OBJ_ENCODED = 2;
    OBJ_STREAM = 3;
  }

  ObjectType Type = 1;
  oneof Object {
    common.ObjectRef Ref = 2;
    common.EncodedObject Encoded = 3;
  }
}

message AppendActor {
  string Name = 1; // actor name
  repeated string Params = 2; // function params
  // execution_ignis.ActorRef Ref = 3; // Ref to actor
}

message Resources {
  int64 CPU = 1; // CPU cores
  int64 Memory = 2; // memory in Bytes
  int64 GPU = 3; // GPU cores
}

message AppendPyFunc {
  string Name = 1; // function name
  repeated string Params = 2; //function params
  string Venv = 3; // function virtual environment
  repeated string Requirements = 4; // function dependencies
    bytes PickledObject = 5; // encoded function impl
    common.Language Language = 6; // return type of function
    Resources Resources = 7; // resources required by function
  int32 Replicas = 8; // number of replicas
  repeated string Tags = 9; // resource tags requirement
}

message AppendPyClass {
  message ClassMethod {
    string Name = 1;
    repeated string Params = 2;
  }

  string Name = 1; // class name
  repeated ClassMethod Methods = 2;
  string Venv = 3; // function virtual environment
  repeated string Requirements = 4; // function dependencies
  bytes PickledObject = 5; // encoded function impl
  common.Language Language = 6; // return type of function
  Resources Resources = 7; // resources required by class
  int32 Replicas = 8;
}

message AppendData {
  string SessionID = 1; // current execution session, empty if shared by all sessions
  string InstanceID = 2; // id of function instance under current execution session
  common.EncodedObject Object = 3; // encoded object
}

message AppendArg {
  string SessionID = 1; // current execution session
  string InstanceID = 2; // id of function instance under current execution session
  string Name = 3; // function name
  string Param = 4; // param name
  Data Value = 5; // object ref for param
}

message AppendClassMethodArg {
  string SessionID = 1; // current execution session
  string InstanceID = 2; // id of **class** instance under current execution session
  string MethodName = 3; // method name
  string Param = 4; // param name
  Data Value = 5; // object ref for param
}

message Invoke {
  string SessionID = 1; // current execution session
  string InstanceID = 2; // id of function instance under current execution session
  string Name = 3; // function name
}

message ReturnResult {
  string SessionID = 1; // current execution session
  string InstanceID = 2; // id of function instance under current execution session
  string Name = 3; // function name
  oneof Result {
    Data Value = 4; // success: return result
    string Error = 5; // fail: return error
  }
}

// DAG Node Messages
message ControlNode {
  string Id = 1;
  string FunctionName = 2;
  map<string, string> Params = 3; // lambda_id -> parameter_name mapping
  int32 Current = 4;
  string DataNode = 5; // id of the output data node
  repeated string PreDataNodes = 6; // ids of input data nodes
  string FunctionType = 7; // "remote" or "local"
}

message DataNode {
  string Id = 1;
  string Lambda = 2; // lambda id
  repeated string SufControlNodes = 3; // ids of successor control nodes
  optional string PreControlNode = 4; // id of predecessor control node (nullable)
  optional string ParentNode = 5; // id of parent data node (nullable)
  repeated string ChildNode = 6; // ids of child data nodes
}

enum DAGNodeType {
  DAG_NODE_TYPE_UNSPECIFIED = 0;
  DAG_NODE_TYPE_CONTROL = 1;
  DAG_NODE_TYPE_DATA = 2;
}

message AppendDAGNode {
  string SessionID = 1; // current execution session
  DAGNodeType Type = 2;
  oneof Node {
    ControlNode ControlNode = 3;
    DataNode DataNode = 4;
  }
}

message RequestObject {
  string ID = 1;
  string Source = 2;
}

message ResponseObject {
  string ID = 1;
  common.EncodedObject Value = 2;
  string Error = 3;
}

message Message {
  CommandType Type = 1;
  string AppID = 2;
  oneof Command {
    common.Ack Ack = 3;
    common.Ready Ready = 4;
    AppendData AppendData = 5;
    AppendActor AppendActor = 6;
    AppendPyFunc AppendPyFunc = 7;
    AppendPyClass AppendPyClass = 8;
    AppendArg AppendArg = 9;
    AppendClassMethodArg AppendClassMethodArg = 10;
    Invoke Invoke = 11;
    ReturnResult ReturnResult = 12;
    AppendDAGNode AppendDAGNode = 13;
    RequestObject RequestObject = 14;
    ResponseObject ResponseObject = 15;
  }
}

service Service {
  rpc Session(stream Message) returns (stream Message) {}
}
